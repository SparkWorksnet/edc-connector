<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDC Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body {
            background: #f8f9fa;
        }

        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35rem 0.65rem;
        }

        .terminated {
            background: black;
        }

        .deprovisioned {
            background: orange;
        }
        .started {
            background: green;
        }

        .finalized {
            background: green;
        }

        .status-completed, .status-finalized {
            background: #d4edda;
            color: #155724;
        }

        .status-started, .status-streaming {
            background: #cce5ff;
            color: #004085;
        }

        .status-failed, .status-terminated {
            background: #f8d7da;
            color: #721c24;
        }

        .count-badge {
            background: #e9ecef;
            color: #495057;
        }

        .table-responsive {
            border-radius: 0.375rem;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5 fw-bold">
                <i class="bi bi-speedometer2 text-primary"></i> EDC Connector Dashboard
            </h1>
        </div>
    </div>

    <!-- Configuration Card -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <div class="col-auto">
                            <label for="apiUrl" class="col-form-label fw-semibold">
                                <i class="bi bi-link-45deg"></i> Management API URL:
                            </label>
                        </div>
                        <div class="col-md-6">
                            <input type="text" id="apiUrl" class="form-control"
                                   placeholder="Management API URL"
                                   value="${API_URL}">
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" onclick="loadAll()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="assets-tab" data-bs-toggle="tab"
                    data-bs-target="#assets" type="button" role="tab">
                <i class="bi bi-box-seam"></i> Assets
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="contracts-tab" data-bs-toggle="tab"
                    data-bs-target="#contracts" type="button" role="tab">
                <i class="bi bi-file-text"></i> Contract Definitions
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="agreements-tab" data-bs-toggle="tab"
                    data-bs-target="#agreements" type="button" role="tab">
                <i class="bi bi-handshake"></i> Contract Agreements
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="negotiations-tab" data-bs-toggle="tab"
                    data-bs-target="#negotiations" type="button" role="tab">
                <i class="bi bi-chat-dots"></i> Negotiations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transfers-tab" data-bs-toggle="tab"
                    data-bs-target="#transfers" type="button" role="tab">
                <i class="bi bi-arrow-left-right"></i> Transfers
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="policies-tab" data-bs-toggle="tab"
                    data-bs-target="#policies" type="button" role="tab">
                <i class="bi bi-shield-lock"></i> Policies
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="mainTabsContent">
        <!-- Assets Tab -->
        <div class="tab-pane fade show active" id="assets" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Assets
                        <span class="badge count-badge" id="assetsCount">0</span>
                    </h5>
                    <button class="btn btn-sm btn-success" onclick="loadAssets()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="assetsContent" class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading assets...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Definitions Tab -->
        <div class="tab-pane fade" id="contracts" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Contract Definitions
                        <span class="badge count-badge" id="contractsCount">0</span>
                    </h5>
                    <button class="btn btn-sm btn-success" onclick="loadContractDefinitions()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="contractsContent" class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading contract definitions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Agreements Tab -->
        <div class="tab-pane fade" id="agreements" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Contract Agreements
                        <span class="badge count-badge" id="agreementsCount">0</span>
                    </h5>
                    <button class="btn btn-sm btn-success" onclick="loadAgreements()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="agreementsContent" class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading contract agreements...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Negotiations Tab -->
        <div class="tab-pane fade" id="negotiations" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Contract Negotiations
                        <span class="badge count-badge" id="negotiationsCount">0</span>
                    </h5>
                    <button class="btn btn-sm btn-success" onclick="loadNegotiations()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="negotiationsContent" class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading negotiations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transfers Tab -->
        <div class="tab-pane fade" id="transfers" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Transfer Processes
                        <span class="badge count-badge" id="transfersCount">0</span>
                    </h5>
                    <button class="btn btn-sm btn-success" onclick="loadTransfers()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="transfersContent" class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading transfers...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policies Tab -->
        <div class="tab-pane fade" id="policies" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Policy Definitions
                        <span class="badge count-badge" id="policiesCount">0</span>
                    </h5>
                    <button class="btn btn-sm btn-success" onclick="loadPolicies()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="policiesContent" class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading policies...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    async function apiCall(endpoint) {
        const apiUrl = document.getElementById('apiUrl').value;

        try {
            const response = await fetch(`${apiUrl}${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "@context": {"@vocab": "https://w3id.org/edc/v0.0.1/ns/"},
                    "@type": "QuerySpec"
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        } catch (error) {
            return {error: error.message};
        }
    }

    async function loadAssets() {
        const content = document.getElementById('assetsContent');
        const count = document.getElementById('assetsCount');
        content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading assets...</p></div>';

        const data = await apiCall('/v3/assets/request');

        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</div>`;
            count.textContent = '0';
            return;
        }

        count.textContent = data.length || 0;

        if (!data.length) {
            content.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">No assets found</p></div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>Name</th><th>Content Type</th><th>Type</th></tr></thead><tbody>';
        data.forEach(asset => {
            html += `<tr>
                    <td><code class="text-primary">${asset['@id']}</code></td>
                    <td>${asset.properties?.name || '<span class="text-muted">N/A</span>'}</td>
                    <td>${asset.properties?.contenttype || '<span class="text-muted">N/A</span>'}</td>
                    <td><span class="badge bg-info">${asset.dataAddress?.type || 'N/A'}</span></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        content.innerHTML = html;
    }

    async function loadContractDefinitions() {
        const content = document.getElementById('contractsContent');
        const count = document.getElementById('contractsCount');
        content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading contract definitions...</p></div>';

        const data = await apiCall('/v3/contractdefinitions/request');

        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</div>`;
            count.textContent = '0';
            return;
        }

        count.textContent = data.length || 0;

        if (!data.length) {
            content.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">No contract definitions found</p></div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>Access Policy</th><th>Contract Policy</th></tr></thead><tbody>';
        data.forEach(contract => {
            html += `<tr>
                    <td><code class="text-primary">${contract['@id']}</code></td>
                    <td><code>${contract.accessPolicyId}</code></td>
                    <td><code>${contract.contractPolicyId}</code></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        content.innerHTML = html;
    }

    async function loadAgreements() {
        const content = document.getElementById('agreementsContent');
        const count = document.getElementById('agreementsCount');
        content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading contract agreements...</p></div>';

        const data = await apiCall('/v3/contractagreements/request');

        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</div>`;
            count.textContent = '0';
            return;
        }

        count.textContent = data.length || 0;

        if (!data.length) {
            content.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">No contract agreements found</p></div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>Asset ID</th><th>Policy ID</th><th>Signing Date</th></tr></thead><tbody>';
        data.forEach(agreement => {
            html += `<tr>
                    <td><code class="text-primary">${agreement['@id']}</code></td>
                    <td><code>${agreement.assetId || '<span class="text-muted">N/A</span>'}</code></td>
                    <td><code>${agreement.policy?.['@id'] || '<span class="text-muted">N/A</span>'}</code></td>
                    <td><small class="text-muted">${new Date(agreement.contractSigningDate * 1000).toLocaleString()}</small></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        content.innerHTML = html;
    }

    async function loadNegotiations() {
        const content = document.getElementById('negotiationsContent');
        const count = document.getElementById('negotiationsCount');
        content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading negotiations...</p></div>';

        const data = await apiCall('/v3/contractnegotiations/request');

        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</div>`;
            count.textContent = '0';
            return;
        }

        count.textContent = data.length || 0;

        if (!data.length) {
            content.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">No negotiations found</p></div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>State</th><th>Type</th><th>Counter Party</th><th>Created</th></tr></thead><tbody>';
        data.forEach(neg => {
            const stateClass = neg.state?.toLowerCase().replace(/_/g, ' ');
            html += `<tr>
                    <td><code class="text-primary">${neg['@id']}</code></td>
                    <td><span class="badge status-badge ${stateClass}">${neg.state}</span></td>
                    <td><span class="badge bg-secondary">${neg.type}</span></td>
                    <td><small class="text-muted">${neg.counterPartyAddress || 'N/A'}</small></td>
                    <td><small class="text-muted">${neg.createdAt} ${new Date(neg.createdAt).toLocaleString()}</small></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        content.innerHTML = html;
    }

    async function loadTransfers() {
        const content = document.getElementById('transfersContent');
        const count = document.getElementById('transfersCount');
        content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading transfers...</p></div>';

        const data = await apiCall('/v3/transferprocesses/request');

        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</div>`;
            count.textContent = '0';
            return;
        }

        count.textContent = data.length || 0;

        if (!data.length) {
            content.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">No transfers found</p></div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>State</th><th>Type</th><th>Asset</th><th>Created</th></tr></thead><tbody>';
        data.forEach(transfer => {
            const stateClass = transfer.state?.toLowerCase();
            console.log(transfer);
            html += `<tr>
                    <td><code class="text-primary">${transfer['@id']}</code></td>
                    <td><span class="badge status-badge ${stateClass}">${transfer.state}</span></td>
                    <td><span class="badge bg-secondary">${transfer.type}</span></td>
                    <td><code>${transfer.assetId || '<span class="text-muted">N/A</span>'}</code></td>
                    <td><small class="text-muted">${new Date(transfer.stateTimestamp).toLocaleString()}</small></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        content.innerHTML = html;
    }

    async function loadPolicies() {
        const content = document.getElementById('policiesContent');
        const count = document.getElementById('policiesCount');
        content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading policies...</p></div>';

        const data = await apiCall('/v3/policydefinitions/request');

        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</div>`;
            count.textContent = '0';
            return;
        }

        count.textContent = data.length || 0;

        if (!data.length) {
            content.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">No policies found</p></div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>Created</th></tr></thead><tbody>';
        data.forEach(policy => {
            html += `<tr>
                    <td><code class="text-primary">${policy['@id']}</code></td>
                    <td><small class="text-muted">${new Date(policy.createdAt).toLocaleString()}</small></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        content.innerHTML = html;
    }

    function loadAll() {
        loadAssets();
        loadContractDefinitions();
        loadAgreements();
        loadNegotiations();
        loadTransfers();
        loadPolicies();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Set API URL based on current hostname
        const apiUrlInput = document.getElementById('apiUrl');
        const defaultApiUrl = `${window.location.protocol}//${window.location.hostname}:${API_PORT}/management`;
        apiUrlInput.value = defaultApiUrl;

        loadAll();
    });
</script>
</body>
</html>
